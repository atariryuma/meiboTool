# テンプレート作成ガイド

このドキュメントは、名簿帳票ツールで使用するExcelテンプレートを手作りする際のリファレンスです。

---

## 1. テンプレートの仕組み

アプリはExcelテンプレート内の `{{プレースホルダー}}` を児童データで自動置換します。

```
テンプレート.xlsx（{{氏名}} {{出席番号}} など）
    ↓ アプリが自動置換
出力.xlsx（山田太郎 1 など）
```

テンプレートは普通のExcelファイルです。列幅・行高・フォント・罫線・結合セルなどを自由に設定できます。

---

## 2. テンプレートの3タイプ

| タイプ | 用途 | プレースホルダー形式 | 例 |
|--------|------|---------------------|-----|
| **grid** | 1ページにN名を配置 | `{{氏名_1}}` `{{氏名_2}}` ... | 名札、名列表、調べ表、横名簿 |
| **list** | データ行を児童数分展開 | `{{氏名}}` `{{生年月日}}` | 修了台帳、卒業台帳 |
| **individual** | 1名/シートで複製 | `{{氏名}}` `{{生年月日}}` | 家庭調査票、学級編成用個票 |

### grid タイプの作り方

セルに `{{フィールド名_番号}}` を配置します。番号は1から連番です。

```
例: 名列表（2列×20行 = 40名分）
  A1: {{出席番号_1}}   B1: {{氏名_1}}   |  D1: {{出席番号_21}}  E1: {{氏名_21}}
  A2: {{出席番号_2}}   B2: {{氏名_2}}   |  D2: {{出席番号_22}}  E2: {{氏名_22}}
  ...
  A20: {{出席番号_20}} B20: {{氏名_20}} |  D20: {{出席番号_40}} E20: {{氏名_40}}
```

**ページネーション**: `cards_per_page` が設定されている場合、児童数がそれを超えるとシートが自動的に複製されます。

### list タイプの作り方

1行目にヘッダー、2行目以降にプレースホルダー行を1行だけ作ります。アプリがその行を児童数分コピーします。

```
例: 台帳
  行1: [ヘッダー] 番号 | 氏名 | 性別 | 生年月日 | ...
  行2: [テンプレート行] {{出席番号}} | {{正式氏名}} | {{性別}} | {{生年月日}} | ...
  ↓ アプリが行2を児童数分コピー展開
```

### individual タイプの作り方

1シート分のレイアウトを作成します。アプリがシート全体を児童数分複製します。

```
例: 家庭調査票（A4 1ページ分のレイアウト）
  {{学年}}年 {{組}}組  番号: {{出席番号}}
  ふりがな: {{正式氏名かな}}
  氏名: {{正式氏名}}
  住所: {{住所}}
  ...
```

---

## 3. 使用可能なプレースホルダー一覧

### 児童データフィールド

| プレースホルダー | 説明 | C4th元カラム | 備考 |
|-----------------|------|-------------|------|
| `{{氏名}}` | 児童氏名（通常） | 名前 | |
| `{{氏名かな}}` | 児童氏名ふりがな | ふりがな | |
| `{{正式氏名}}` | 正式氏名（IVS異体字含む） | 正式名前 | 台帳・個票向け |
| `{{正式氏名かな}}` | 正式氏名ふりがな | 正式名前ふりがな | |
| `{{性別}}` | 性別 | 性別 | |
| `{{生年月日}}` | 生年月日 | 生年月日 | YY/MM/DD形式に自動変換 |
| `{{外国籍}}` | 外国籍フラグ | 外国籍 | |
| `{{学年}}` | 学年 | 学年 | |
| `{{組}}` | 組（クラス） | — | アプリ上で選択 |
| `{{出席番号}}` | 出席番号 | — | アプリ上で選択 |

### 住所・連絡先

| プレースホルダー | 説明 | 備考 |
|-----------------|------|------|
| `{{住所}}` | 住所（4フィールド自動結合） | 都道府県+市区町村+町番地+建物名 |
| `{{郵便番号}}` | 郵便番号 | |
| `{{電話番号1}}` | 電話番号1 | |
| `{{電話番号2}}` | 電話番号2 | |
| `{{電話番号3}}` | 電話番号3 | |
| `{{FAX番号}}` | FAX番号 | |

### 保護者情報

| プレースホルダー | 説明 |
|-----------------|------|
| `{{保護者名}}` | 保護者氏名（通常） |
| `{{保護者名かな}}` | 保護者氏名ふりがな |
| `{{保護者正式名}}` | 保護者正式氏名 |
| `{{保護者正式名かな}}` | 保護者正式氏名ふりがな |
| `{{保護者続柄}}` | 続柄（父・母等） |
| `{{緊急連絡先}}` | 緊急連絡先 |

### その他の児童データ

| プレースホルダー | 説明 |
|-----------------|------|
| `{{生徒コード}}` | C4th生徒コード |
| `{{出身校}}` | 出身校 |
| `{{入学日}}` | 入学日（YY/MM/DD形式に自動変換） |
| `{{転入日}}` | 転入日（YY/MM/DD形式に自動変換） |

### 共通ヘッダーフィールド（全テンプレートで使用可能）

| プレースホルダー | 説明 | 値の出所 |
|-----------------|------|---------|
| `{{年度}}` | 年度（西暦） | config設定 |
| `{{年度和暦}}` | 年度（和暦、例: 令和7年度） | 自動計算 |
| `{{学校名}}` | 学校名 | config設定 |
| `{{担任名}}` | 担任名 | アプリ上で入力 |

### grid タイプ専用（番号付き）

grid タイプでは上記フィールドに `_番号` を付けて使用します:

```
{{氏名_1}}  {{氏名_2}}  {{氏名_3}} ...
{{氏名かな_1}}  {{氏名かな_2}} ...
{{出席番号_1}}  {{出席番号_2}} ...
{{性別_1}}  {{性別_2}} ...
{{生年月日_1}}  {{生年月日_2}} ...
{{住所_1}}  {{住所_2}} ...
```

すべてのデータフィールドに `_N` を付けて番号付きにできます。

---

## 4. 名前表示モード（name_display）

アプリには3つの名前表示モードがあります。テンプレート作成時に考慮してください。

| モード | `{{氏名かな}}` の表示 | `{{氏名}}` の表示 |
|--------|---------------------|-------------------|
| **furigana**（デフォルト） | ふりがな値 | 漢字氏名 |
| **kanji** | 空白 | 漢字氏名 |
| **kana** | 空白 | ふりがな値 |

**設計のコツ**: ふりがな行を小さめ（8〜11pt）にしておくと、kanjiモードで空白になっても自然な区切り線として機能します。

---

## 5. テンプレートの登録方法

### ステップ1: Excelでテンプレートを作成

1. Excelを開いて新規ブック作成
2. レイアウトを設計（列幅・行高・罫線・フォント）
3. セルにプレースホルダーを配置
4. **印刷プレビュー**で実寸確認・微調整
5. `テンプレート/` フォルダに保存

### ステップ2: template_registry.py に登録

`meibo_tool/templates/template_registry.py` の `TEMPLATES` に追加:

```python
'テンプレート表示名': {
    'file': 'ファイル名.xlsx',        # テンプレートフォルダ内のファイル名
    'type': 'grid',                    # grid / list / individual
    'cards_per_page': 40,              # grid: 1ページの最大人数（省略=単一ページ）
    'orientation': 'portrait',         # portrait(縦) / landscape(横)
    'use_formal_name': False,          # True: 正式氏名を優先使用
    'required_columns': ['氏名'],      # 必須データカラム
    'mandatory_columns': ['組', '出席番号'],  # 常に必須
    'icon': '📋',                      # UI表示用アイコン
    'description': '説明文',           # UI表示用説明
},
```

### ステップ3: 動作確認

アプリを起動してテンプレートを選択→生成→印刷確認。

---

## 6. 印刷設定の推奨値

テンプレートのExcel内で「ページレイアウト」タブから設定するか、template_registry.pyのメタデータで制御します。

### 推奨マージン

| 用途 | 左右マージン | 上下マージン | 備考 |
|------|-------------|-------------|------|
| 名札・ラベル系 | 0.5cm (0.20") | 0.5cm (0.20") | 用紙いっぱいに使う |
| 台帳系 | 0.5cm (0.20") | 0.5cm (0.20") | 横置きで列数が多い |
| 個票系（家庭調査票等） | 1.0cm (0.39") | 1.0cm (0.39") | 読みやすさ重視 |

### 印刷設定のポイント

- **用紙サイズ**: A4 (Excel設定値: 9)
- **縮小印刷**: 「ページ幅に合わせる」を推奨（fitToWidth=1）
- **中央配置**: 「水平方向に中央揃え」を推奨
- **フォント**: IPAmj明朝（アプリが出力時に自動適用するため、テンプレート内のフォント指定は上書きされます）

---

## 7. トラブルシューティング

### 印刷がずれる場合

1. **Excelの印刷プレビュー**でテンプレート単体の表示を確認
2. マージン設定を見直す（余白が足りないと縮小される）
3. `fitToWidth=1` が設定されているか確認
4. プリンタドライバの「拡大/縮小」設定が100%になっているか確認

### プレースホルダーが置換されない場合

1. `{{` と `}}` が正しく閉じているか確認（全角の `｛｛` は不可）
2. フィールド名が正確か確認（大文字/小文字、全角/半角に注意）
3. grid タイプで番号を付け忘れていないか（`{{氏名}}` ではなく `{{氏名_1}}`）
4. 結合セルの左上セルにプレースホルダーを配置しているか確認

### 結合セルの注意

- **プレースホルダーは結合セルの左上セルにのみ配置**してください
- 結合セルの左上以外に配置すると、MergedCell エラーで置換されません

---

## 8. 既存テンプレート一覧

| ファイル名 | タイプ | 向き | 1ページ最大 | 説明 |
|-----------|--------|------|------------|------|
| 名札_通常.xlsx | grid | 縦 | 20名 | 両面同一生徒印刷 |
| 名札_装飾あり.xlsx | grid | 縦 | 40名 | ピンク装飾枠 |
| 名札_1年生用.xlsx | grid | 縦 | 8名 | 縦書きふりがな |
| ラベル_大2.xlsx | grid | 縦 | 40名 | 黒・2列 |
| ラベル_小.xlsx | grid | 縦 | 20名 | 両面2-up |
| ラベル_特大.xlsx | grid | 縦 | 40名 | 72pt大文字 |
| 掲示用名列表.xlsx | grid | 縦 | 40名 | ふりがなつき2列 |
| 調べ表.xlsx | grid | 縦 | 60名 | 6列×10行グリッド |
| 横名簿.xlsx | grid | 横 | 40名 | 出欠欄10日分 |
| 縦一週間.xlsx | grid | 縦 | 40名 | 週間出欠表 |
| 修了台帳.xlsx | list | 横 | — | 年度末修了記録 |
| 卒業台帳.xlsx | list | 横 | — | 卒業証書番号付き |
| 家庭調査票.xlsx | individual | 縦 | 1名/シート | 家庭環境調査 |
| 学級編成用個票.xlsx | individual | 縦 | 1名/シート | 学級編成資料 |
